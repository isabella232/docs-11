<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="no-js ie6"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8"><![endif]-->
<!--[if IE 9 ]><html class="no-js ie9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    
      
        <title>How It Works - Quiet Modem Project</title>
      
      
      
      
    
    <meta property="og:url" content="">
    <meta property="og:title" content="Quiet Modem Project">
    <meta property="og:image" content="https://avatars2.githubusercontent.com/u/17815378?v=3&s=200">
    <meta name="apple-mobile-web-app-title" content="Quiet Modem Project">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
      <link rel="apple-touch-icon" href="https://avatars2.githubusercontent.com/u/17815378?v=3&s=200">
    
    <link rel="shortcut icon" type="image/x-icon" href="../assets/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="../assets/images/favicon.ico">
    <style>
      @font-face {
      	font-family: 'Icon';
      	src: url('../assets/fonts/icon.eot?52m981');
      	src: url('../assets/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
      		   url('../assets/fonts/icon.woff?52m981')
               format('woff'),
      		   url('../assets/fonts/icon.ttf?52m981')
               format('truetype'),
      		   url('../assets/fonts/icon.svg?52m981#icon')
               format('svg');
      	font-weight: normal;
      	font-style: normal;
      }
    </style>
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="../assets/stylesheets/application-prettified.css">
    
    
      
      
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
      <style>
        body, input {
          font-family: 'Roboto', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        pre, code {
          font-family: 'Roboto Mono', 'Courier New', 'Courier', monospace;
        }
      </style>
    
    <link rel="stylesheet" href="../assets/stylesheets/select.css">
    
    <script src="../assets/javascripts/modernizr-4ab42b99fd.js"></script>
    
  </head>
  
  
  
  <body class=" ">
    
      
      
    
    <div class="backdrop">
      <div class="backdrop-paper"></div>
    </div>
    <input class="toggle" type="checkbox" id="toggle-drawer">
    <input class="toggle" type="checkbox" id="toggle-search">
    <label class="toggle-button overlay" for="toggle-drawer"></label>
    <header class="header">
      <nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
        How It Works
      </div>
    </div>
    
    
    <div class="button button-search" role="button" aria-label="Search">
      <label class="toggle-button icon icon-search" title="Search" for="toggle-search"></label>
    </div>
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
    </header>
    <main class="main">
      
      <div class="drawer">
        <nav aria-label="Navigation">
  
  <a href="https://github.com/quiet/quiet-js" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="https://avatars2.githubusercontent.com/u/17815378?v=3&s=200">
        </div>
      
      <div class="name">
        <strong>
          Quiet Modem Project
          <span class="version">
            
          </span>
        </strong>
        
          <br>
          quiet/quiet-js
        
      </div>
    </div>
  </a>
  <div class="scrollable">
    <div class="project-select">
      <select>
        
        
        <option  data-url="https://quiet.github.io/docs/quiet/how/">C</option>
        
        <option selected data-url="https://quiet.github.io/docs/quiet-js/how/">Javascript</option>
        
        <option  data-url="https://quiet.github.io/docs/QuietModemKit/how/">iOS</option>
        
        <option  data-url="https://quiet.github.io/docs/org.QuietModem.Quiet/how/">Android</option>
        
      </select>
    </div>
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            
            <a href="https://github.com/quiet/quiet-js/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/quiet/quiet-js/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      
      <div class="toc">
        <ul>
          
            <div></div>
            
  <li>
    <a class="" title="Quiet Modem" href="..">
      Quiet Modem
    </a>
    
  </li>

          
            <div></div>
            
  <li>
    <a class="" title="Getting Started" href="../setup/">
      Getting Started
    </a>
    
  </li>

          
            <div></div>
            
  <li>
    <a class="" title="Example" href="../example/">
      Example
    </a>
    
  </li>

          
            <div></div>
            
  <li>
    <a class="current" title="How It Works" href="./">
      How It Works
    </a>
    
      
      
        
      
      
        <ul>
          
            <li class="anchor">
              <a title="Soundcard" href="#soundcard">
                Soundcard
              </a>
            </li>
          
            <li class="anchor">
              <a title="Modulation" href="#modulation">
                Modulation
              </a>
            </li>
          
            <li class="anchor">
              <a title="Transmitting" href="#transmitting">
                Transmitting
              </a>
            </li>
          
            <li class="anchor">
              <a title="Receiving" href="#receiving">
                Receiving
              </a>
            </li>
          
            <li class="anchor">
              <a title="Demodulation" href="#demodulation">
                Demodulation
              </a>
            </li>
          
            <li class="anchor">
              <a title="Thread Safety" href="#thread-safety">
                Thread Safety
              </a>
            </li>
          
            <li class="anchor">
              <a title="Quiet.js" href="#quietjs">
                Quiet.js
              </a>
            </li>
          
        </ul>
      
    
  </li>

          
            <div></div>
            
  <li>
    <a class="" title="Profiles" href="../profiles/">
      Profiles
    </a>
    
  </li>

          
            <div></div>
            
  <li>
    <a class="" title="Transmitting Data" href="../transmitting/">
      Transmitting Data
    </a>
    
  </li>

          
            <div></div>
            
  <li>
    <a class="" title="Receiving Data" href="../receiving/">
      Receiving Data
    </a>
    
  </li>

          
        </ul>
        
      </div>
    </div>
  </div>
</nav>
      </div>
      <article class="article">
        <div class="wrapper">
          
          <h1 id="how-it-works">How It Works</h1>
<p>Quiet Modem encodes your data into sound that can be played by your speakers. These sounds can then be detected through a microphone and converted back into data.</p>
<p>This section of the documentation is optional. It can be skipped if you just wish to begin using the modem. However, if you need to debug your modem, it can be helpful to understand how these libraries work.</p>
<h2 id="soundcard">Soundcard</h2>
<hr />
<p>In order to understand what it means to play sound, it helps to first demonstrate how your sounds work within your computer. When we want to represent a sound, we sample it at periodic intervals in time. Each sample is rounded to one of thousands of discrete intensity levels in a process known as <a href="https://en.wikipedia.org/wiki/Pulse-code_modulation">Pulse-Code Modulation</a>. We refer to the number of samples represented in a single second as the sample rate. The most common sample rate for digital audio is 44,100 Hz (samples per second). The sample rate applies both to sounds that we want to play and sounds that we are recording. The computer has a sound card or chip which is responsible for converting analog sounds to digital samples and vice versa.</p>
<p>Quiet Modem operates internally at the sample rate of 44,100 Hz. Each sample is generated as a 32-bit floating-point value between -1 and 1. In fact, Quiet can operate across any channel that can transmit these floating point numbers, though the degree of success will depend on how much the samples are distorted after they are transmitted.</p>
<h2 id="modulation">Modulation</h2>
<hr />
<p><img src="../img/modulator-block-diagram.png" alt="Modulator Block Diagram" style="max-width: 600px;"/></p>
<p>As described in the section on soundcards, we will be operating on individual samples of sound. We know that we will be sending and receiving individual samples, each of which can be assigned a single floating-point value. We also know that these values will eventually have to be played as analog electrical signals which excite sounds through a speaker. We will convert data to sample values through a process known as modulation.</p>
<p>Quiet Modem uses <a href="http://liquidsdr.org/">Liquid SDR</a> to do the heavily lifting for its modulation tasks. This section is describing mostly how parts of Liquid work. The key points are repeated in this documentation so that users of Quiet should not have to rely too heavily on Liquid's documentation.</p>
<h3 id="framing">Framing</h3>
<p>Quiet Modem sends data in chunks, which we will call frames. Each frame can be thought of as a completely self-contained packet of data. The start of each frame contains a synchronization sequence that allows the receiver to have a good chance of decoding the frame. Quiet performs checksumming on the contents of each frame so that it can discard frames that have picked up errors in transmission.</p>
<p>A single frame of data has a maxium payload size that it can carry. This size will depend on the specific configuration used, but in general, a frame will be converted into at most one or two seconds of sound. Frames that are longer than this are more likely to encounter errors.</p>
<div class="admonition warning">
<p><strong>It is up to the user of Quiet's libraries to split data into frames.</strong> Quiet will discard frames that are longer than the configured transmitter's maximum frame length. Although this is somewhat inconvenient, the upside is that frames are given back to the user in the same structure when received. This means that if you wish to use e.g. the first byte of each frame to signal when a message is starting or ending, you will always be able to find this marker at the first byte.</p>
</div>
<h3 id="checksum">Checksum</h3>
<p>Quiet offers automatic <a href="https://en.wikipedia.org/wiki/Checksum">checksum verification</a> of frames. The strongest of these methods offered is <a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check">CRC32</a> which will fail nearly every time if even a single bit in the received frame is incorrect. Some applications may wish to disable checksums if receiving an incorrect message is preferable to receiving no message.</p>
<p>For this step, Quiet generates the checksum and then sets it aside for later. The checksum itself will be passed in a different part of the frame from where the user payload goes.</p>
<h3 id="error-correction">Error Correction</h3>
<p>Before we modulate our frame, we can add redundancy to it. This redundancy allows the receiver to recover our original message even when some errors occur in transmission. This process is known as <a href="https://en.wikipedia.org/wiki/Forward_error_correction">Forward Error Correction</a>.</p>
<p>As an example, you can imagine that we repeat each bit of our message three times. Then when the receiver receives this message, it picks whichever bit occurs most often &mdash; if two of these three bits are '0' and one is '1', then we pick '0' as the original message bit.</p>
<p>Modern forward error correction is more sophisticated than simply repeating bits, but, as a consequence, not as easy to explain. Quiet Modem relies on the modes provided by Liquid SDR. In particular, it makes use of <a href="https://en.wikipedia.org/wiki/Convolutional_code">Convolutional Codes</a> and <a href="https://en.wikipedia.org/wiki/Reed%E2%80%93Solomon_error_correction">Reed-Solomon</a>. Once we apply these methods to our original message, we take the resulting bits and pass them on to our modulator.</p>
<h3 id="payload-modulator">Payload Modulator</h3>
<p>Liquid SDR offers a wide range of modulation options, and so it is beyond the scope of this page to fully explain all of them. If you are curious which specific options Quiet provides, the documentation on <a href="../profiles/">Profiles</a> offers more details. Quiet makes use of Liquid's standard modems, OFDM and GMSK modes. For this section, we will explore one of the most basic modes, BPSK.</p>
<p>In <a href="https://en.wikipedia.org/wiki/Phase-shift_keying">binary phase-shift keying</a>, we assign each bit of the message we want to send into a sequence of floating-point samples. Each sample will represent a single bit of data. If we want to send a binary '0', then we create a new sample with a floating-point value of -1.0. If we instead want to send binary '1', then we assign the value of 1.0. Other modulation schemes can send more bits of data in each sample by picking more intermediate values, e.g. -0.5 and 0.5 and even <a href="https://en.wikipedia.org/wiki/Complex_number">complex values</a>.</p>
<p>We now have floating-point samples where previously we had binary digits. If you were given the sequence created above, it would be easy to recover the original message. Unfortunately, we would not have much luck simply sending this sequence as it is. We will need to condition these samples so that they can deal with limitations in our real-world speaker. We will also need to make it easier for the receiver to find where our message starts.</p>
<h2 id="transmitting">Transmitting</h2>
<hr />
<p><img alt="Encoding Block Diagram" src="../img/encoder-block-diagram.png" /></p>
<p>Just as in our section on modulation, this section mostly describes functionality provided by Liquid DSP.</p>
<h3 id="preamble">Preamble</h3>
<p>Our receiver will be looking at a continuous stream of floating-point samples from the soundcard, waiting to see our message. These samples will contain all of the background noise near the microphone as well as whatever message we are sending. We need a way to tell the receiver that our message is about to begin so that it will know to interpret the samples it is seeing as message bits.</p>
<p>The way that we accomplish this is by using a predetermined, pseudorandom sequence of samples. We will start every message we send with this sequence so that the receiver will know unambiguously that our message is about to start. It will be much easier for the receiver to look for this specific sequence and then assume that the message follows immediately after. This sequence is known as the preamble. The preamble does <em>not</em> need to be modulated &mdash; the sequence itself is what we send.</p>
<h3 id="header">Header</h3>
<p>The header is a short block of data sent before the payload. The header contains information on which type of modulation and error correction are used in the payload. It also contains the actual checksum generated for the payload. A short checksum is sent for the contents of the header itself.</p>
<h3 id="header-modulator">Header Modulator</h3>
<p>Just as our message was modulated to floating-point samples, we will apply error correction and modulation to the data in the header. The kinds used here can be different from the one used for the payload. We want the header to be especially reliable since an error in the header can make it impossible to receive the payload correctly.</p>
<h3 id="assembling-the-frame">Assembling the Frame</h3>
<p>We now have all of the samples needed to send our frame. We start by sending the preamble samples, followed by the header samples, and finally the payload samples.</p>
<h3 id="interpolation">Interpolation</h3>
<p>Interpolation is a process that allows us to restrict how quickly our signal changes values by inserting new 'fill' samples between each of our existing samples. We will fill in samples with values of 0 so that they do not change the overall energy in the signal. Next, all samples (original + fill) have their values smoothed out by evaluating a specially chosen polynomial that prefers slow changes in values over fast changes in values. In other words, we use a filter.</p>
<p>The new sequence of resulting samples will change less rapidly than the original, restricted to a narrower band of frequencies. The number of fill samples we choose allows us to control how much smaller the band gets. Inserting a single sample halves the range; inserting two reduces it to a third, and so on. Using a narrower frequency band will often give our data a better chance of being transmitted successfully. The downside is that it now takes us more samples to send the same message, which means our effective transmission speed is reduced.</p>
<p>We will apply this interpolation to the full contents of the frame, not just the part with our message.</p>
<h3 id="upconversion">Upconversion</h3>
<p>Our interpolator reduced the bandwidth of our message, but the resulting waveform is very low frequency, centered at 0 Hz. Speakers do not work well at very low frequencies, so we will want to move our message out of that range through upconversion. Upconversion allows us to move the center of this transmission up to a new frequency, but with the same bandwidth as before upconversion.</p>
<p>For example, if our original transmission has a bandwidth of 4,000 Hz, and we upconvert it by 8,000 Hz, then it will sit at the range of 6,000 Hz to 10,000 Hz after upconversion.</p>
<p>This process is what allows us to go into the near-ultrasonic range. If we use interpolation to reduce our transmission be fairly narrow and then upconvert to 19kHz or so, the result will sit entirely above 18kHz, which is well above the hearing range for nearly everyone.</p>
<h3 id="gain-reduction">Gain Reduction</h3>
<p>This step multiplies all values in the signal by some small fraction. This reduces the likelihood that the signal will clip beyond the acceptable range of [-1.0, 1.0], which our soundcard would reject. It also makes the transmission quieter so that it will be a reasonable volume regardless of how loud the user's volume settings are set to.</p>
<h3 id="block-buffer">Block Buffer</h3>
<p>We now have a stream of floating-point samples that is ready to be sent through the speaker. Soundcards expect to receive samples in blocks instead of one sample at a time. The soundcard's block length has to be preconfigured and some power of 2, commonly in the range of 256 (2^8) to 16384 (2^16). This step collects samples into bunches to match the soundcard's block length.</p>
<p>If too many samples are generated to fit into one block, Quiet sends one block's worth and stores the rest for the next block. If more samples are needed to fill a block, Quiet checks its send queue to see if more data frames are ready and fills with silence otherwise.</p>
<h2 id="receiving">Receiving</h2>
<hr />
<p><img alt="Decoding Block Diagram" src="../img/decoder-block-diagram.png" /></p>
<p>The receiver is running on a separate device from the transmitter. Here we will take samples collected by our microphone and decode the transmitted message.</p>
<h3 id="block-buffer_1">Block Buffer</h3>
<p>The soundcard will have collected floating-point samples of sound recorded by the microphone. These samples are sent to us in blocks made of multiple samples, just as when we sent samples to the speaker. Each block's length is a some power of 2.</p>
<p>Our block buffer serves as a temporary store of samples as we run the decoding process.</p>
<h3 id="downconversion">Downconversion</h3>
<p>We have to invert the upconversion process so that the original signal's center is shifted back down to 0 Hz. This should be matched to the transmitter so that we shift down by the same frequency interval that we shifted up.</p>
<h3 id="decimation">Decimation</h3>
<p>This step inverts interpolation. First we apply a low-pass filter to our signal and then we throw away samples. This should also be matched to the transmitter. For example, if we had chosen to interpolate by 2, now we will decimate by 2.</p>
<h3 id="frame-detection">Frame Detection</h3>
<p>The resulting stream of samples should now resemble what we transmitted. When we sent our frame, we started it with a preamble. Now we will search for the preamble in the incoming samples. This is an ongoing process and will continue to run as long as no preamble is found.</p>
<h3 id="synchronization-and-equalization">Synchronization and Equalization</h3>
<h3 id="demodulate-header">Demodulate Header</h3>
<h2 id="demodulation">Demodulation</h2>
<hr />
<p><img alt="Demodulator Block Diagram" src="../img/demodulator-block-diagram.png" /></p>
<h3 id="demodulation_1">Demodulation</h3>
<h3 id="error-correction_1">Error Correction</h3>
<h3 id="data-integrity">Data Integrity</h3>
<h2 id="thread-safety">Thread Safety</h2>
<hr />
<h3 id="ring-buffer">Ring Buffer</h3>
<h3 id="send-queue">Send Queue</h3>
<h3 id="receive-queue">Receive Queue</h3>
<h2 id="quietjs">Quiet.js</h2>
<hr />
<h3 id="emscripten">Emscripten</h3>
<h3 id="javascript-wrapper">Javascript Wrapper</h3>
          <aside class="copyright" role="note">
            
            Documentation built with
            <a href="http://www.mkdocs.org" target="_blank">MkDocs</a>
            using the
            <a href="http://squidfunk.github.io/mkdocs-material/" target="_blank">
              Material
            </a>
            theme.
          </aside>
          
            <footer class="footer">
              
  <nav class="pagination" aria-label="Footer">
    <div class="previous">
      
        <a href="../example/" title="Example">
          <span class="direction">
            Previous
          </span>
          <div class="page">
            <div class="button button-previous" role="button" aria-label="Previous">
              <i class="icon icon-back"></i>
            </div>
            <div class="stretch">
              <div class="title">
                Example
              </div>
            </div>
          </div>
        </a>
      
    </div>
    <div class="next">
      
        <a href="../profiles/" title="Profiles">
          <span class="direction">
            Next
          </span>
          <div class="page">
            <div class="stretch">
              <div class="title">
                Profiles
              </div>
            </div>
            <div class="button button-next" role="button" aria-label="Next">
              <i class="icon icon-forward"></i>
            </div>
          </div>
        </a>
      
    </div>
  </nav>

            </footer>
          
        </div>
      </article>
      <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
          <div class="wrapper">
            <div class="meta"></div>
            <div class="list"></div>
          </div>
        </div>
      </div>
    </main>
    <script>
      var base_url = '..';
      var repo_id  = 'quiet/quiet-js';
      var page_url = 'http://localhost:8080/quiet-doc/quiet-js/how/';
    </script>
    <script src="../assets/javascripts/application-997097ee0c.js"></script>
    <script src="../assets/javascripts/select.js"></script>
    
    
  </body>
</html>